{{ define "main" }}

<h1>{{ .Title }}</h1>

<script src="{{ "monsters-data.js" | relURL }}"></script>

<section>
  <h2>主人公ステータス</h2>
  <div class="hero-grid">
    <div class="hero-row"><span class="hero-label">atk:</span><input id="hero-atk" type="number" inputmode="numeric" min="0" step="1" value="0"></div>
    <div class="hero-row"><span class="hero-label">int:</span><input id="hero-int" type="number" inputmode="numeric" min="0" step="1" value="0"></div>
    <div class="hero-row"><span class="hero-label">spd:</span><input id="hero-spd" type="number" inputmode="numeric" min="0" step="1" value="0"></div>
  </div>
</section>

<section class="enemy-section">
  <h2>モンスター</h2>
  <div class="enemy-picker">
    <div class="enemy-row">
      <span class="enemy-label">name:</span>
      <div class="enemy-input-wrap">
        <input id="monster-search" type="text" placeholder="名前で検索して選択" autocomplete="off">
        <div id="monster-suggest" class="suggest" hidden></div>
      </div>
    </div>

    <div class="enemy-selected" id="monster-selected" hidden>
      選択中: <strong id="monster-selected-name"></strong>
    </div>

    <div class="enemy-row mt">
      <span class="enemy-label">Lv:</span>
      <div class="lv-shortcuts" id="lv-shortcuts"></div>
    </div>

    <div class="enemy-row mt">
      <span class="enemy-label">Lv:</span>
      <input id="enemy-lv" class="lv-input" type="number" inputmode="numeric" min="1" step="1" value="1" disabled>
    </div>

    <div class="enemy-row mt">
      <span class="enemy-label">magic:</span>
      <div class="magic-buttons">
        <button id="magic-wood" type="button" disabled>木魔法</button>
        <button id="magic-dark" type="button" disabled>闇魔法</button>
      </div>
    </div>
  </div>
</section>

<section class="action-section">
  <button id="calc-btn" type="button" disabled>計算</button>
</section>

<section class="result-section">
  <h2>結果</h2>

  <div class="result-block">
    <div class="result-title">物理</div>
    <div class="result-row">
      <div class="result-label">与ダメ範囲</div>
      <div class="result-value">
        <span id="out-phy-dmg">-</span>
        <span class="muted">（多段: <span id="out-hits">-</span>）</span>
      </div>
    </div>
    <div class="result-row">
      <div class="result-label">ワンパンライン</div>
      <div class="result-value" id="out-phy-one">-</div>
    </div>
  </div>

  <div class="result-block">
    <div class="result-title">魔法</div>
    <div class="result-row">
      <div class="result-label">与ダメ範囲</div>
      <div class="result-value" id="out-mag-dmg">-</div>
    </div>
    <div class="result-row">
      <div class="result-label">ワンパンライン</div>
      <div class="result-value" id="out-mag-one">-</div>
    </div>
  </div>

  <div class="result-block">
    <div class="result-title">命中 / 回避</div>
    <div class="result-row">
      <div class="result-label">命中luk</div>
      <div class="result-value" id="out-hit-luk">-</div>
    </div>
    <div class="result-row">
      <div class="result-label">回避luk</div>
      <div class="result-value" id="out-evade-luk">-</div>
    </div>
  </div>

  <div class="result-block">
    <div class="result-title">
      無効化 <span class="muted">（防御=def+0.1mdef / 魔法防御=mdef+0.1def）</span>
    </div>
    <div class="result-row">
      <div class="result-label">必要防御</div>
      <div class="result-value" id="out-null-def">-</div>
    </div>
    <div class="result-row">
      <div class="result-label">必要魔法防御</div>
      <div class="result-value" id="out-null-mdef">-</div>
    </div>
  </div>
</section>

<style>
.hero-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;max-width:720px;}
.hero-row{display:flex;align-items:center;gap:8px;}
.hero-label{font-weight:600;}
.hero-row input{flex:1;padding:8px 10px;border:none;border-bottom:1px solid #000;background:transparent;}

.enemy-section{margin-top:22px;}
.enemy-picker{max-width:720px;}
.enemy-row{display:flex;align-items:center;gap:8px;}
.enemy-label{font-weight:600;min-width:56px;}
.enemy-input-wrap{position:relative;flex:1;}
#monster-search{width:100%;padding:10px;border:1px solid #000;border-radius:10px;}
.suggest{position:absolute;left:0;right:0;top:calc(100% + 6px);border:1px solid #000;border-radius:10px;background:#fff;max-height:260px;overflow-y:auto;}
.suggest button{display:block;width:100%;text-align:left;padding:10px;border:none;background:transparent;}
.mt{margin-top:12px;}
.lv-shortcuts{display:flex;flex-wrap:wrap;gap:8px;}
.lv-shortcuts button{padding:8px 10px;border:1px solid #000;background:#fff;border-radius:10px;}
.lv-input{flex:1;padding:10px;border:1px solid #000;border-radius:10px;}

.magic-buttons{display:flex;gap:10px;}
.magic-buttons button{padding:10px 12px;border:1px solid #000;background:#fff;border-radius:10px;}
.magic-buttons button[aria-pressed="true"]{background:rgba(0,0,0,0.08);}
.magic-buttons button:disabled{opacity:.4;}

.action-section{margin-top:16px;max-width:720px;}
#calc-btn{width:100%;padding:12px;border:1px solid #000;border-radius:12px;background:#fff;}
#calc-btn:disabled{opacity:.35;background:#eee;}
#calc-btn:not(:disabled){box-shadow:0 0 0 2px #000 inset;}
#calc-btn:active:not(:disabled){transform:scale(0.99);}

.result-section{margin-top:20px;max-width:720px;}
.result-block{border:1px solid #000;border-radius:14px;padding:12px;margin-top:12px;}
.result-title{font-weight:700;margin-bottom:8px;}
.result-row{display:flex;justify-content:space-between;padding:6px 0;}
.result-label{font-weight:600;}
.result-value{text-align:right;}
.muted{opacity:.7;}
</style>

<script>
function hitsFromSpd(spd){
  const s=Math.floor(Number(spd));
  if(s<=3000)return 1;
  if(s<=9999)return 2;
  if(s<=29999)return 3;
  if(s<=99999)return 4;
  return 5;
}
function scaleStat(base,lv){return Math.floor(Number(base)*(1+lv*0.1));}
function damageRangeTotal(attack,defense,hits){
  const base=(attack*7)-(defense*4);
  if(base<=0)return{min:0,max:0};
  return{
    min:Math.floor(base*0.9*hits),
    max:Math.floor(base*1.1*hits)
  };
}
function oneShotLineRequiredAttack(defense,hits,hp){
  const need=hp/(0.9*hits);
  return Math.max(0,Math.ceil((defense*4+need)/7));
}
function requiredDefenseForNullify(enemyAttack){
  const x=(enemyAttack*7-10)/4;
  return Math.max(0,Math.floor(x)+1);
}

document.getElementById("calc-btn").addEventListener("click",()=>{
  if(!window.enemyScaled)return;

  const atk=Number(heroAtk.value)||0;
  const intl=Number(heroInt.value)||0;
  const spd=Number(heroSpd.value)||0;

  const hits=hitsFromSpd(spd);
  outHits.textContent=hits;

  const physDef=enemyScaled.def+enemyScaled.mdef*0.1;
  const magDef=enemyScaled.mdef+enemyScaled.def*0.1;

  const phy=damageRangeTotal(atk,physDef,hits);
  outPhyDmg.textContent=`${phy.min}～${phy.max}`;

  const mag=damageRangeTotal(intl,magDef,1);
  outMagDmg.textContent=`${mag.min}～${mag.max}`;

  const hp=enemyScaled.vit*18+100;

  outPhyOne.textContent=`atk${oneShotLineRequiredAttack(physDef,hits,hp)}以上`;
  outMagOne.textContent=`int${oneShotLineRequiredAttack(magDef,1,hp)}以上`;

  outHitLuk.textContent=`${Math.floor(enemyScaled.luk/2)}以上`;
  outEvadeLuk.textContent=`${Math.floor(enemyScaled.luk*3)}以上`;

  outNullDef.textContent=`${requiredDefenseForNullify(enemyScaled.atk)}以上`;
  outNullMdef.textContent=`${requiredDefenseForNullify(enemyScaled.int)}以上`;
});
</script>

{{ end }}
