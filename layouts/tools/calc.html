{{ define "main" }}

<h1>{{ .Title }}</h1>

<script src="{{ "monsters-data.js" | relURL }}"></script>

<section>
  <h2>主人公ステータス</h2>

  <div class="hero-grid">
    <div class="hero-row"><span class="hero-label">atk:</span><input id="hero-atk" type="number" inputmode="numeric" min="0" step="1" value="0"></div>
    <div class="hero-row"><span class="hero-label">int:</span><input id="hero-int" type="number" inputmode="numeric" min="0" step="1" value="0"></div>
    <div class="hero-row"><span class="hero-label">spd:</span><input id="hero-spd" type="number" inputmode="numeric" min="0" step="1" value="0"></div>
    <div class="hero-row"><span class="hero-label">luk:</span><input id="hero-luk" type="number" inputmode="numeric" min="0" step="1" value="0"></div>
    <div class="hero-row"><span class="hero-label">def:</span><input id="hero-def" type="number" inputmode="numeric" min="0" step="1" value="0"></div>
    <div class="hero-row"><span class="hero-label">mdef:</span><input id="hero-mdef" type="number" inputmode="numeric" min="0" step="1" value="0"></div>
  </div>
</section>

<section class="enemy-section">
  <h2>モンスター</h2>

  <div class="enemy-picker">
    <div class="enemy-row">
      <span class="enemy-label">name:</span>
      <div class="enemy-input-wrap">
        <input id="monster-search" type="text" placeholder="名前で検索して選択" autocomplete="off">
        <div id="monster-suggest" class="suggest" hidden></div>
      </div>
    </div>

    <div class="enemy-selected" id="monster-selected" hidden>
      選択中: <strong id="monster-selected-name"></strong>
    </div>

    <div class="enemy-row mt" aria-label="level shortcuts">
      <span class="enemy-label">Lv:</span>
      <div class="lv-shortcuts" id="lv-shortcuts"></div>
    </div>

    <div class="enemy-row mt">
      <span class="enemy-label">Lv:</span>
      <input id="enemy-lv" class="lv-input" type="number" inputmode="numeric" min="1" step="1" value="1" disabled>
    </div>

    <div class="enemy-row mt">
      <span class="enemy-label">magic:</span>
      <div class="magic-buttons">
        <button id="magic-wood" type="button" disabled>木魔法</button>
        <button id="magic-dark" type="button" disabled>闇魔法</button>
      </div>
    </div>
  </div>
</section>

<section class="action-section">
  <button id="calc-btn" type="button" disabled>計算</button>
</section>

<div id="calc-app"></div>

<style>
  .hero-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;max-width:720px;}
  .hero-row{display:flex;align-items:center;gap:8px;}
  .hero-label{font-weight:600;white-space:nowrap;}
  .hero-row input{flex:1;min-width:0;padding:8px 10px;border:none;outline:none;background:transparent;font-size:16px;border-bottom:1px solid #000;border-radius:0;}

  .enemy-section{margin-top:22px;}
  .enemy-picker{max-width:720px;}
  .enemy-row{display:flex;align-items:center;gap:8px;}
  .enemy-label{font-weight:600;white-space:nowrap;min-width:56px;}
  .enemy-input-wrap{position:relative;flex:1;min-width:0;}
  #monster-search{width:100%;padding:10px;border:1px solid #000;border-radius:10px;font-size:16px;}
  .suggest{position:absolute;left:0;right:0;top:calc(100% + 6px);border:1px solid #000;border-radius:10px;background:#fff;overflow:hidden;max-height:260px;overflow-y:auto;z-index:20;}
  .suggest button{display:block;width:100%;text-align:left;padding:10px 12px;border:none;background:transparent;font-size:16px;}
  .suggest button:active{background:rgba(0,0,0,0.06);}
  .enemy-selected{margin-top:10px;}
  .mt{margin-top:12px;}
  .lv-shortcuts{display:flex;flex-wrap:wrap;gap:8px;flex:1;}
  .lv-shortcuts button{padding:8px 10px;border:1px solid #000;background:#fff;border-radius:10px;font-size:14px;}
  .lv-input{flex:1;min-width:0;padding:10px;border:1px solid #000;border-radius:10px;font-size:16px;}

  .magic-buttons{display:flex;gap:10px;flex:1;}
  .magic-buttons button{padding:10px 12px;border:1px solid #000;background:#fff;border-radius:10px;font-size:14px;}
  .magic-buttons button[aria-pressed="true"]{background:rgba(0,0,0,0.08);}
  .magic-buttons button:disabled{opacity:.4;}

  .action-section{margin-top:16px;max-width:720px;}
  #calc-btn{
  width:100%;
  padding:12px 14px;
  border:1px solid #000;
  border-radius:12px;
  background:#fff;
  font-size:16px;
  }
  #calc-btn:disabled{
  opacity:.35;
  background: #eee;
  }
  #calc-btn:not(:disabled){
  background: #fff;
  box-shadow: 0 0 0 2px #000 inset;
  }
  #calc-btn:active:not(:disabled){
  transform: scale(0.99);
  }
</style>

<script>
  // ========== 共通：整数・0以上（主人公） ==========
  (function () {
    const ids = ["hero-atk","hero-int","hero-spd","hero-luk","hero-def","hero-mdef"];
    function normalizeNonNegInt(el){
      const raw = (el.value ?? "").toString().trim();
      if (raw === "") { el.value = "0"; return; }
      const n = Math.floor(Number(raw));
      if (!Number.isFinite(n) || n < 0) { el.value = "0"; return; }
      el.value = String(n);
    }
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      normalizeNonNegInt(el);
      el.addEventListener("blur", () => normalizeNonNegInt(el));
    });
  })();

  // ========== 敵Lv：1以上整数 ==========
  function normalizeLv(el){
    const raw = (el.value ?? "").toString().trim();
    if (raw === "") { el.value = "1"; return 1; }
    const n = Math.floor(Number(raw));
    if (!Number.isFinite(n) || n < 1) { el.value = "1"; return 1; }
    el.value = String(n);
    return n;
  }

  // ========== 敵ステ計算（Lv反映：切り捨て） ==========
  function scaleStat(base, lv){
    return Math.floor(base * (1 + lv * 0.1));
  }
  function buildEnemyScaled(monster, lv, magic){
    const wood = !!magic?.wood;
    const dark = !!magic?.dark;

    const defScaled = scaleStat(monster.def, lv);
    const lukScaled = scaleStat(monster.luk, lv);

    return {
      id: monster.id,
      title: monster.title,
      lv,
      vit: scaleStat(monster.vit, lv),
      spd: scaleStat(monster.spd, lv),
      atk: scaleStat(monster.atk, lv),
      int: scaleStat(monster.int, lv),
      def: wood ? Math.floor(defScaled / 2) : defScaled,
      mdef: scaleStat(monster.mdef, lv),
      luk: dark ? Math.floor(lukScaled / 2) : lukScaled,
      level_shortcuts: Array.isArray(monster.level_shortcuts) ? monster.level_shortcuts : []
    };
  }

  // ========== モンスター検索・選択 + level_shortcut + Lv入力 + 魔法 + 計算ボタン ==========
  (function () {
    const LS_KEY = "calc_state_v1";

    const calcBtn = document.getElementById("calc-btn");

    const search = document.getElementById("monster-search");
    const suggest = document.getElementById("monster-suggest");
    const selectedBox = document.getElementById("monster-selected");
    const selectedName = document.getElementById("monster-selected-name");

    const lvInput = document.getElementById("enemy-lv");
    const shortcutWrap = document.getElementById("lv-shortcuts");

    const woodBtn = document.getElementById("magic-wood");
    const darkBtn = document.getElementById("magic-dark");

    let picked = null;
    let currentLv = 1;
    let enemyScaled = null;

    const magic = { wood:false, dark:false };

    function setCalcEnabled(){
      calcBtn.disabled = !picked;
    }

    function saveState(){
      try{
        const hero = {
          atk: document.getElementById("hero-atk").value,
          int: document.getElementById("hero-int").value,
          spd: document.getElementById("hero-spd").value,
          luk: document.getElementById("hero-luk").value,
          def: document.getElementById("hero-def").value,
          mdef: document.getElementById("hero-mdef").value
        };
        const st = { monster_id: picked ? picked.id : "", lv: currentLv, hero, magic };
        localStorage.setItem(LS_KEY, JSON.stringify(st));
      }catch(e){}
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return;
        const st = JSON.parse(raw);

        if (st?.hero){
          const map = {
            "hero-atk":"atk","hero-int":"int","hero-spd":"spd","hero-luk":"luk","hero-def":"def","hero-mdef":"mdef"
          };
          Object.keys(map).forEach(id=>{
            const el = document.getElementById(id);
            if (!el) return;
            const v = st.hero[map[id]];
            if (v !== undefined && v !== null) el.value = String(v);
          });
        }
        if (Number.isFinite(Number(st?.lv))) currentLv = Math.max(1, Math.floor(Number(st.lv)));
        if (st?.magic){
          magic.wood = !!st.magic.wood;
          magic.dark = !!st.magic.dark;
        }
      }catch(e){}
    }

    function closeSuggest(){ suggest.hidden = true; suggest.innerHTML = ""; }

    function setMagicButtonState(){
      woodBtn.setAttribute("aria-pressed", magic.wood ? "true" : "false");
      darkBtn.setAttribute("aria-pressed", magic.dark ? "true" : "false");
    }
    function enableMagicButtons(enabled){
      woodBtn.disabled = !enabled;
      darkBtn.disabled = !enabled;
    }

    function renderShortcuts(shortcuts){
      shortcutWrap.innerHTML = "";
      const arr = Array.isArray(shortcuts) ? shortcuts : [];
      if (!picked) return;
      if (arr.length === 0) return;

      arr.forEach(v => {
        const lv = Math.floor(Number(v));
        if (!Number.isFinite(lv) || lv < 1) return;
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = String(lv);
        btn.addEventListener("click", () => {
          currentLv = lv;
          lvInput.value = String(lv);
          enemyScaled = buildEnemyScaled(picked, currentLv, magic);
          saveState();
        });
        shortcutWrap.appendChild(btn);
      });
    }

    function applyPickedUI(){
      if (!picked){
        selectedBox.hidden = true;
        selectedName.textContent = "";
        lvInput.disabled = true;
        lvInput.value = String(currentLv);
        shortcutWrap.innerHTML = "";
        enemyScaled = null;

        enableMagicButtons(false);
        setCalcEnabled();
        return;
      }

      selectedName.textContent = picked.title;
      selectedBox.hidden = false;

      lvInput.disabled = false;
      lvInput.value = String(currentLv);

      renderShortcuts(picked.level_shortcuts);

      enableMagicButtons(true);
      setMagicButtonState();

      enemyScaled = buildEnemyScaled(picked, currentLv, magic);
      saveState();
      setCalcEnabled();
    }

    function openSuggest(items){
      suggest.hidden = false;
      suggest.innerHTML = "";
      items.forEach(m => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = m.title;
        btn.addEventListener("click", () => {
          picked = m;
          search.value = m.title;
          applyPickedUI();
          closeSuggest();
        });
        suggest.appendChild(btn);
      });
    }

    function clearPicked(){
      picked = null;
      enemyScaled = null;
      selectedBox.hidden = true;
      selectedName.textContent = "";
      lvInput.disabled = true;
      lvInput.value = String(currentLv);
      shortcutWrap.innerHTML = "";

      enableMagicButtons(false);
      saveState();
      setCalcEnabled();
    }

    function normalizeJP(s){
      const str = (s ?? "").toString().trim().toLowerCase();
      return str.replace(/[\u30A1-\u30F6]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60));
    }
    function filterMonsters(q){
      if (!Array.isArray(window.MONSTERS)) return [];
      const query = normalizeJP(q);
      if (query.length === 0) return [];
      return window.MONSTERS.filter(m => normalizeJP(m.title ?? "").includes(query)).slice(0, 50);
    }

    // 初期：保存状態復元
    loadState();
    lvInput.value = String(currentLv);
    setMagicButtonState();
    enableMagicButtons(false);
    setCalcEnabled();

    ["hero-atk","hero-int","hero-spd","hero-luk","hero-def","hero-mdef"].forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("blur", saveState);
    });

    (function restorePicked(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return;
        const st = JSON.parse(raw);
        const mid = (st?.monster_id ?? "").toString();
        if (!mid || !Array.isArray(window.MONSTERS)) return;
        const found = window.MONSTERS.find(m => String(m.id) === mid);
        if (!found) return;
        picked = found;
        search.value = found.title;
        applyPickedUI();
      }catch(e){}
    })();

    search.addEventListener("input", () => {
      const q = search.value;

      if (q.trim() === "") {
        clearPicked();
        closeSuggest();
        return;
      }

      if (picked && q !== picked.title) {
        clearPicked();
      }

      const items = filterMonsters(q);
      if (items.length === 0) closeSuggest();
      else openSuggest(items);
    });

    search.addEventListener("focus", () => {
      const items = filterMonsters(search.value);
      if (items.length === 0) closeSuggest();
      else openSuggest(items);
    });

    document.addEventListener("click", (e) => {
      const t = e.target;
      if (t === search || suggest.contains(t)) return;
      closeSuggest();
    });

    lvInput.addEventListener("blur", () => {
      if (!picked) return;
      currentLv = normalizeLv(lvInput);
      enemyScaled = buildEnemyScaled(picked, currentLv, magic);
      saveState();
    });

    woodBtn.addEventListener("click", () => {
      if (!picked) return;
      magic.wood = !magic.wood;
      setMagicButtonState();
      enemyScaled = buildEnemyScaled(picked, currentLv, magic);
      saveState();
    });

    darkBtn.addEventListener("click", () => {
      if (!picked) return;
      magic.dark = !magic.dark;
      setMagicButtonState();
      enemyScaled = buildEnemyScaled(picked, currentLv, magic);
      saveState();
    });

    // 計算ボタン：今は結果更新の起点だけ（後でここに計算処理を足す）
    calcBtn.addEventListener("click", () => {
      if (!picked || !enemyScaled) return;
      // 後で結果エリア更新を実装
      // console.log("calc", { enemyScaled, magic });
    });
  })();
</script>

{{ end }}
